<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Finder</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom styles */
        .leaflet-control {
            z-index: 800;
        }
        
        .search-results {
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Fix for default marker icon in Leaflet */
        .leaflet-default-icon-path {
            background-image: url(https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png);
        }
        
        .leaflet-default-shadow-path {
            background-image: url(https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto py-6 space-y-6 px-4">
        <!-- Header Card -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6 border-b">
                <h1 class="text-2xl font-bold">Multi-Waypoint Route Finder</h1>
                <p class="text-gray-500">Find the distance and route between multiple locations in Indonesia</p>
            </div>
            
            <div class="p-6">
                <!-- Map Selection Alert -->
                <div id="mapSelectionAlert" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md flex items-start gap-2">
                    <i data-lucide="map-pin" class="w-5 h-5 text-blue-500 mt-0.5"></i>
                    <div>
                        <h3 class="font-medium">Map Selection Mode</h3>
                        <p>Click on the map to select the location for waypoint <span id="activeWaypointLabel"></span></p>
                    </div>
                </div>
                
                <!-- Waypoints Container -->
                <div id="waypointsContainer" class="space-y-4">
                    <!-- Waypoints will be added here dynamically -->
                </div>
                
                <!-- Add Waypoint Button -->
                <button id="addWaypointBtn" class="w-full mt-4 py-2 px-4 border border-gray-300 rounded-md flex items-center justify-center gap-2 hover:bg-gray-50">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Add Waypoint</span>
                </button>
                
                <!-- Calculate Route Button -->
                <button id="calculateRouteBtn" class="w-full mt-4 py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">
                    <span>Calculate Route</span>
                </button>
                
                <!-- Error Alert -->
                <div id="errorAlert" class="hidden mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md">
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="mapContainer" class="h-[500px] w-full rounded-lg overflow-hidden border shadow-md bg-white"></div>
        
        <!-- Route Information Card -->
        <div id="routeInfoCard" class="hidden bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold">Route Information</h2>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Distance</p>
                        <p id="totalDistance" class="text-2xl font-bold">0 km</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Estimated Duration</p>
                        <p id="totalDuration" class="text-2xl font-bold">0 hours 0 minutes</p>
                    </div>
                </div>
                
                <!-- Segment Details -->
                <div id="segmentDetailsContainer" class="mt-6">
                    <h3 class="text-lg font-medium mb-2">Segment Details</h3>
                    <div class="border rounded-md overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Segment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                </tr>
                            </thead>
                            <tbody id="segmentDetailsBody" class="bg-white divide-y divide-gray-200">
                                <!-- Segment rows will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Waypoint type definition (for documentation)
        // type Waypoint = {
        //   id: string,
        //   name: string,
        //   coords: [number, number] | null
        // }
        
        // Application state
        const state = {
            waypoints: [
                { id: 'waypoint-0', name: '', coords: null },
                { id: 'waypoint-1', name: '', coords: null }
            ],
            routes: [],
            segmentDistances: [],
            segmentDurations: [],
            totalDistance: null,
            totalDuration: null,
            activeWaypointIndex: null,
            mapSelectionMode: false,
            searchResults: [],
            showResults: false,
            map: null,
            markers: [],
            polylines: []
        };
        
        // DOM Elements
        const waypointsContainer = document.getElementById('waypointsContainer');
        const addWaypointBtn = document.getElementById('addWaypointBtn');
        const calculateRouteBtn = document.getElementById('calculateRouteBtn');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const mapContainer = document.getElementById('mapContainer');
        const mapSelectionAlert = document.getElementById('mapSelectionAlert');
        const activeWaypointLabel = document.getElementById('activeWaypointLabel');
        const routeInfoCard = document.getElementById('routeInfoCard');
        const totalDistance = document.getElementById('totalDistance');
        const totalDuration = document.getElementById('totalDuration');
        const segmentDetailsBody = document.getElementById('segmentDetailsBody');
        
        // Initialize map
        function initMap() {
            // Create map
            state.map = L.map(mapContainer).setView([-7.2575, 112.7521], 13); // Default to Surabaya, Indonesia
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(state.map);
            
            // Add click event handler
            state.map.on('click', handleMapClick);
            
            // Render initial waypoints
            renderWaypoints();
        }
        
        // Create a custom icon for markers
        function createMarkerIcon(index) {
            return L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }
        
        // Render waypoints in the UI
        function renderWaypoints() {
            waypointsContainer.innerHTML = '';
            
            state.waypoints.forEach((waypoint, index) => {
                const isActive = state.activeWaypointIndex === index;
                const waypointElement = document.createElement('div');
                waypointElement.className = 'space-y-1';
                
                // Label
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium';
                label.textContent = index === 0 
                    ? 'Start Location' 
                    : index === state.waypoints.length - 1 
                        ? 'End Location' 
                        : `Waypoint ${index}`;
                waypointElement.appendChild(label);
                
                // Input container
                const inputContainer = document.createElement('div');
                inputContainer.className = 'flex items-center gap-2';
                
                // Input wrapper
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'relative flex-1';
                
                if (isActive) {
                    // Search input when active
                    const searchContainer = document.createElement('div');
                    searchContainer.className = 'relative';
                    
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'flex gap-2';
                    
                    // Search input
                    const searchInput = document.createElement('input');
                    searchInput.type = 'text';
                    searchInput.placeholder = 'Search for a location...';
                    searchInput.className = 'w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                    searchInput.id = `search-input-${index}`;
                    searchInput.autocomplete = 'off';
                    
                    // Search button
                    const searchButton = document.createElement('button');
                    searchButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center gap-2';
                    searchButton.innerHTML = `
                        <i data-lucide="search" class="w-4 h-4"></i>
                        <span>Search</span>
                    `;
                    
                    // Handle search button click
                    searchButton.addEventListener('click', () => {
                        const value = searchInput.value;
                        if (value.length >= 3) {
                            searchLocations(value, index);
                        } else {
                            // Show error for too short search term
                            const errorContainer = document.getElementById(`search-error-${index}`);
                            if (errorContainer) {
                                errorContainer.textContent = 'Please enter at least 3 characters';
                                errorContainer.style.display = 'block';
                            }
                        }
                    });
                    
                    // Handle enter key press
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const value = e.target.value;
                            if (value.length >= 3) {
                                searchLocations(value, index);
                            } else {
                                // Show error for too short search term
                                const errorContainer = document.getElementById(`search-error-${index}`);
                                if (errorContainer) {
                                    errorContainer.textContent = 'Please enter at least 3 characters';
                                    errorContainer.style.display = 'block';
                                }
                            }
                        }
                    });
                    
                    // Clear button
                    const clearButton = document.createElement('button');
                    clearButton.className = 'absolute right-[90px] top-0 h-full px-2';
                    clearButton.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
                    clearButton.style.display = 'none'; // Hide initially
                    
                    clearButton.addEventListener('click', () => {
                        searchInput.value = '';
                        clearButton.style.display = 'none';
                        hideSearchResults(index);
                        
                        // Hide error message if visible
                        const errorContainer = document.getElementById(`search-error-${index}`);
                        if (errorContainer) {
                            errorContainer.style.display = 'none';
                        }
                    });
                    
                    // Show/hide clear button based on input
                    searchInput.addEventListener('input', () => {
                        clearButton.style.display = searchInput.value ? 'flex' : 'none';
                        
                        // Hide error message when typing
                        const errorContainer = document.getElementById(`search-error-${index}`);
                        if (errorContainer) {
                            errorContainer.style.display = 'none';
                        }
                    });
                    
                    // Map selection button
                    const mapSelectionBtn = document.createElement('button');
                    mapSelectionBtn.className = 'ml-2 px-2 py-2 border rounded-md';
                    mapSelectionBtn.innerHTML = '<i data-lucide="map-pin" class="w-4 h-4"></i>';
                    mapSelectionBtn.title = 'Select on map';
                    
                    mapSelectionBtn.addEventListener('click', () => {
                        startMapSelection(index);
                    });
                    
                    // Remove waypoint button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-2 px-2 py-2 border rounded-md';
                    removeBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                    removeBtn.title = 'Remove waypoint';
                    removeBtn.disabled = state.waypoints.length <= 2;
                    
                    if (state.waypoints.length <= 2) {
                        removeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    
                    removeBtn.addEventListener('click', () => {
                        if (state.waypoints.length > 2) {
                            removeWaypoint(index);
                        }
                    });
                    
                    // Add elements to the DOM
                    inputGroup.appendChild(searchInput);
                    inputGroup.appendChild(searchButton);
                    searchContainer.appendChild(inputGroup);
                    searchContainer.appendChild(clearButton);
                    inputWrapper.appendChild(searchContainer);
                    
                    // Search results container
                    const resultsContainer = document.createElement('div');
                    resultsContainer.className = 'absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto search-results';
                    resultsContainer.id = `search-results-${index}`;
                    resultsContainer.style.display = 'none';
                    inputWrapper.appendChild(resultsContainer);
                    
                    // Loading indicator
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'absolute right-[90px] top-0 h-full flex items-center pr-3';
                    loadingIndicator.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-gray-400"></i>';
                    loadingIndicator.id = `loading-indicator-${index}`;
                    loadingIndicator.style.display = 'none';
                    searchContainer.appendChild(loadingIndicator);
                    
                    // Error message
                    const errorContainer = document.createElement('div');
                    errorContainer.className = 'mt-1 text-sm text-red-500';
                    errorContainer.id = `search-error-${index}`;
                    errorContainer.style.display = 'none';
                    searchContainer.appendChild(errorContainer);
                    
                    inputContainer.appendChild(inputWrapper);
                    inputContainer.appendChild(mapSelectionBtn);
                    inputContainer.appendChild(removeBtn);
                    
                    // Focus the input after rendering
                    setTimeout(() => {
                        searchInput.focus();
                    }, 0);
                    
                } else {
                    // Display waypoint when not active
                    const displayContainer = document.createElement('div');
                    displayContainer.className = 'flex';
                    
                    // Display input
                    const displayInput = document.createElement('input');
                    displayInput.type = 'text';
                    displayInput.readOnly = true;
                    displayInput.value = waypoint.name;
                    displayInput.placeholder = `Select ${index === 0 ? 'start' : index === state.waypoints.length - 1 ? 'end' : 'waypoint'} location`;
                    displayInput.className = `w-full px-4 py-2 border rounded-md cursor-pointer ${waypoint.coords ? 'border-green-500' : ''}`;
                    
                    displayInput.addEventListener('click', () => {
                        setActiveWaypoint(index);
                    });
                    
                    // Map selection button
                    const mapSelectionBtn = document.createElement('button');
                    mapSelectionBtn.className = 'ml-2 px-2 py-2 border rounded-md';
                    mapSelectionBtn.innerHTML = '<i data-lucide="map-pin" class="w-4 h-4"></i>';
                    mapSelectionBtn.title = 'Select on map';
                    
                    mapSelectionBtn.addEventListener('click', () => {
                        startMapSelection(index);
                    });
                    
                    // Remove waypoint button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-2 px-2 py-2 border rounded-md';
                    removeBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                    removeBtn.title = 'Remove waypoint';
                    removeBtn.disabled = state.waypoints.length <= 2;
                    
                    if (state.waypoints.length <= 2) {
                        removeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    
                    removeBtn.addEventListener('click', () => {
                        if (state.waypoints.length > 2) {
                            removeWaypoint(index);
                        }
                    });
                    
                    displayContainer.appendChild(displayInput);
                    inputWrapper.appendChild(displayContainer);
                    inputContainer.appendChild(inputWrapper);
                    inputContainer.appendChild(mapSelectionBtn);
                    inputContainer.appendChild(removeBtn);
                }
                
                waypointElement.appendChild(inputContainer);
                
                // Coordinates display
                if (waypoint.coords) {
                    const coordsDisplay = document.createElement('p');
                    coordsDisplay.className = 'text-xs text-green-600';
                    coordsDisplay.textContent = `Location set: ${waypoint.coords[0].toFixed(6)}, ${waypoint.coords[1].toFixed(6)}`;
                    waypointElement.appendChild(coordsDisplay);
                }
                
                waypointsContainer.appendChild(waypointElement);
            });
            
            // Initialize Lucide icons for the newly added elements
            lucide.createIcons();
        }
        
        // Set active waypoint for searching
        function setActiveWaypoint(index) {
            state.activeWaypointIndex = index;
            renderWaypoints();
        }
        
        // Start map selection mode
        function startMapSelection(index) {
            state.activeWaypointIndex = index;
            state.mapSelectionMode = true;
            
            // Update UI
            mapSelectionAlert.classList.remove('hidden');
            activeWaypointLabel.textContent = index + 1;
            
            // Hide any active search results
            hideSearchResults(index);
            
            // Render waypoints to update UI
            renderWaypoints();
        }
        
        // Handle map click for location selection
        async function handleMapClick(e) {
            if (!state.mapSelectionMode || state.activeWaypointIndex === null) return;
            
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Get location name from coordinates
            const locationName = await reverseGeocode(lat, lng);
            
            // Update the waypoint
            state.waypoints[state.activeWaypointIndex] = {
                ...state.waypoints[state.activeWaypointIndex],
                name: locationName,
                coords: [lat, lng]
            };
            
            // Exit map selection mode
            state.mapSelectionMode = false;
            state.activeWaypointIndex = null;
            
            // Update UI
            mapSelectionAlert.classList.add('hidden');
            renderWaypoints();
            
            // Update map markers
            updateMapMarkers();
            
            // Center map on the selected location
            state.map.setView([lat, lng], 13);
        }
        
        // Reverse geocode coordinates to get location name
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
                    headers: {
                        'User-Agent': 'RouteFinderApp/1.0',
                        'Accept-Language': 'en'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Reverse geocoding error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.display_name || `Location at ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return `Location at ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }
        
        // Search for locations based on keyword
        async function searchLocations(keyword, waypointIndex) {
            if (!keyword || keyword.length < 3) return;
            
            // Show loading indicator
            const loadingIndicator = document.getElementById(`loading-indicator-${waypointIndex}`);
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            
            // Hide error message
            const errorContainer = document.getElementById(`search-error-${waypointIndex}`);
            if (errorContainer) errorContainer.style.display = 'none';
            
            try {
                // Use Django view as proxy to Nominatim
                const response = await fetch(`/api/geocode/?query=${encodeURIComponent(keyword)}`);
                
                if (!response.ok) {
                    throw new Error(`Geocoding API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    // Show error message
                    if (errorContainer) {
                        errorContainer.textContent = `No locations found for "${keyword}". Try adding more details.`;
                        errorContainer.style.display = 'block';
                    }
                } else {
                    // Display search results
                    displaySearchResults(data, waypointIndex);
                }
            } catch (error) {
                console.error('Error searching locations:', error);
                
                // Show error message
                if (errorContainer) {
                    errorContainer.textContent = 'Error searching for locations. Please try again.';
                    errorContainer.style.display = 'block';
                }
            } finally {
                // Hide loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }
        
        // Display search results
        function displaySearchResults(results, waypointIndex) {
            const resultsContainer = document.getElementById(`search-results-${waypointIndex}`);
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = '';
            
            const resultsList = document.createElement('div');
            resultsList.className = 'divide-y';
            
            results.forEach((result, idx) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-start gap-2';
                
                resultItem.innerHTML = `
                    <i data-lucide="map-pin" class="w-5 h-5 text-gray-500 shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm">${result.display_name}</p>
                        <p class="text-xs text-gray-500 mt-1">${result.lat}, ${result.lon}</p>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    selectLocation(result, waypointIndex);
                });
                
                resultsList.appendChild(resultItem);
            });
            
            resultsContainer.appendChild(resultsList);
            resultsContainer.style.display = 'block';
            
            // Initialize Lucide icons for the newly added elements
            lucide.createIcons();
        }
        
        // Hide search results
        function hideSearchResults(waypointIndex) {
            const resultsContainer = document.getElementById(`search-results-${waypointIndex}`);
            if (resultsContainer) {
                resultsContainer.style.display = 'none';
            }
        }
        
        // Select location from search results
        function selectLocation(location, waypointIndex) {
            // Update the waypoint
            state.waypoints[waypointIndex] = {
                ...state.waypoints[waypointIndex],
                name: location.display_name,
                coords: [parseFloat(location.lat), parseFloat(location.lon)]
            };
            
            // Reset active waypoint
            state.activeWaypointIndex = null;
            
            // Update UI
            renderWaypoints();
            
            // Update map markers
            updateMapMarkers();
            
            // Center map on the selected location
            state.map.setView([parseFloat(location.lat), parseFloat(location.lon)], 13);
        }
        
        // Add a new waypoint
        function addWaypoint() {
            const newId = `waypoint-${state.waypoints.length}`;
            state.waypoints.push({ id: newId, name: '', coords: null });
            renderWaypoints();
        }
        
        // Remove a waypoint
        function removeWaypoint(index) {
            if (state.waypoints.length <= 2) {
                showError('You need at least two waypoints (start and end)');
                return;
            }
            
            state.waypoints.splice(index, 1);
            renderWaypoints();
            updateMapMarkers();
        }
        
        // Update map markers
        function updateMapMarkers() {
            // Clear existing markers
            state.markers.forEach(marker => state.map.removeLayer(marker));
            state.markers = [];
            
            // Add markers for waypoints with coordinates
            state.waypoints.forEach((waypoint, index) => {
                if (waypoint.coords) {
                    const marker = L.marker(waypoint.coords, {
                        icon: createMarkerIcon(index)
                    }).addTo(state.map);
                    
                    const popupContent = `${index === 0 ? 'Start' : index === state.waypoints.length - 1 ? 'End' : `Waypoint ${index}`}: ${waypoint.name}`;
                    marker.bindPopup(popupContent);
                    
                    state.markers.push(marker);
                }
            });
            
            // Fit map to markers if there are any
            if (state.markers.length > 0) {
                const group = new L.featureGroup(state.markers);
                state.map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }
        
        // Calculate route between waypoints
        async function calculateRoute() {
            // Check if all waypoints have names and coordinates
            if (state.waypoints.some(wp => !wp.name || !wp.coords)) {
                showError('Please set all waypoint locations before calculating the route');
                return;
            }
            
            if (state.waypoints.length < 2) {
                showError('You need at least two waypoints to calculate a route');
                return;
            }
            
            // Show loading state
            calculateRouteBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-2"></i> Finding Route...';
            calculateRouteBtn.disabled = true;
            hideError();
            
            // Clear previous routes
            clearRoutes();
            
            try {
                // Calculate routes between consecutive waypoints
                const newRoutes = [];
                const newSegmentDistances = [];
                const newSegmentDurations = [];
                let accumulatedDistance = 0;
                let accumulatedDuration = 0;
                
                for (let i = 0; i < state.waypoints.length - 1; i++) {
                    const start = state.waypoints[i].coords;
                    const end = state.waypoints[i + 1].coords;
                    
                    try {
                        // Get route from OSRM
                        const routeResult = await fetch(
                            `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`
                        );
                        
                        if (!routeResult.ok) {
                            throw new Error(`Failed to calculate route segment ${i + 1}: ${routeResult.statusText}`);
                        }
                        
                        const routeData = await routeResult.json();
                        
                        if (routeData.code !== 'Ok') {
                            throw new Error(
                                `Could not calculate route segment ${i + 1}: ${routeData.message || 'No route found between these locations'}`
                            );
                        }
                        
                        // Extract route coordinates, distance and duration
                        const routeCoordinates = routeData.routes[0].geometry.coordinates.map(
                            coord => [coord[1], coord[0]]
                        );
                        
                        const segmentDistance = routeData.routes[0].distance / 1000; // km
                        const segmentDuration = routeData.routes[0].duration / 60; // minutes
                        
                        newRoutes.push(routeCoordinates);
                        newSegmentDistances.push(segmentDistance);
                        newSegmentDurations.push(segmentDuration);
                        
                        accumulatedDistance += segmentDistance;
                        accumulatedDuration += segmentDuration;
                        
                        // Draw route on map
                        const polyline = L.polyline(routeCoordinates, {
                            color: i % 2 === 0 ? 'blue' : 'purple',
                            weight: 5
                        }).addTo(state.map);
                        
                        state.polylines.push(polyline);
                        
                    } catch (error) {
                        throw new Error(
                            `Error calculating route from "${state.waypoints[i].name}" to "${state.waypoints[i + 1].name}": ${error.message}`
                        );
                    }
                    
                    // Add a small delay before the next request
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Update state
                state.routes = newRoutes;
                state.segmentDistances = newSegmentDistances;
                state.segmentDurations = newSegmentDurations;
                state.totalDistance = accumulatedDistance;
                state.totalDuration = accumulatedDuration;
                
                // Update UI with route information
                updateRouteInfo();
                
                // Fit map to show all routes
                if (state.polylines.length > 0) {
                    const group = new L.featureGroup(state.polylines);
                    state.map.fitBounds(group.getBounds(), { padding: [50, 50] });
                }
                
            } catch (error) {
                showError(error.message || 'An error occurred while finding the route');
                console.error(error);
            } finally {
                // Reset button state
                calculateRouteBtn.innerHTML = 'Calculate Route';
                calculateRouteBtn.disabled = false;
                
                // Reinitialize Lucide icons
                lucide.createIcons();
            }
        }
        
        // Clear routes from map
        function clearRoutes() {
            // Clear polylines
            state.polylines.forEach(polyline => state.map.removeLayer(polyline));
            state.polylines = [];
            
            // Reset route data
            state.routes = [];
            state.segmentDistances = [];
            state.segmentDurations = [];
            state.totalDistance = null;
            state.totalDuration = null;
            
            // Hide route info
            routeInfoCard.classList.add('hidden');
        }
        
        // Update route information in the UI
        function updateRouteInfo() {
            if (state.totalDistance === null || state.totalDuration === null) {
                routeInfoCard.classList.add('hidden');
                return;
            }
            
            // Show route info card
            routeInfoCard.classList.remove('hidden');
            
            // Update total distance and duration
            totalDistance.textContent = `${state.totalDistance.toFixed(2)} km`;
            
            const hours = Math.floor(state.totalDuration / 60);
            const minutes = Math.round(state.totalDuration % 60);
            totalDuration.textContent = `${hours} hours ${minutes} minutes`;
            
            // Update segment details
            segmentDetailsBody.innerHTML = '';
            
            state.segmentDistances.forEach((distance, index) => {
                const row = document.createElement('tr');
                
                const segmentCell = document.createElement('td');
                segmentCell.className = 'px-6 py-4 whitespace-nowrap text-sm';
                segmentCell.textContent = `${state.waypoints[index].name.substring(0, 20)}... â†’ ${state.waypoints[index + 1].name.substring(0, 20)}...`;
                
                const distanceCell = document.createElement('td');
                distanceCell.className = 'px-6 py-4 whitespace-nowrap text-sm';
                distanceCell.textContent = `${distance.toFixed(2)} km`;
                
                const durationCell = document.createElement('td');
                durationCell.className = 'px-6 py-4 whitespace-nowrap text-sm';
                const segmentHours = Math.floor(state.segmentDurations[index] / 60);
                const segmentMinutes = Math.round(state.segmentDurations[index] % 60);
                durationCell.textContent = `${segmentHours} h ${segmentMinutes} min`;
                
                row.appendChild(segmentCell);
                row.appendChild(distanceCell);
                row.appendChild(durationCell);
                
                segmentDetailsBody.appendChild(row);
            });
        }
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
        }
        
        // Hide error message
        function hideError() {
            errorAlert.classList.add('hidden');
        }
        
        // Add event listeners
        addWaypointBtn.addEventListener('click', addWaypoint);
        calculateRouteBtn.addEventListener('click', calculateRoute);
        
        // Close search results when clicking outside
        document.addEventListener('click', (event) => {
            const target = event.target;
            const isSearchInput = target.id && target.id.startsWith('search-input-');
            const isSearchResult = target.closest('[id^="search-results-"]');
            
            if (!isSearchInput && !isSearchResult) {
                // Hide all search results
                document.querySelectorAll('[id^="search-results-"]').forEach(el => {
                    el.style.display = 'none';
                });
            }
        });
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
        });
    </script>
</body>
</html>

